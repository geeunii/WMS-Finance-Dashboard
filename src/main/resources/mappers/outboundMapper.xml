<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssg.wms.outbound.mappers.OutboundMapper">

    <!-- ✅ 출고요청 리스트 매핑 -->
    <resultMap id="OutboundRequestListMap" type="com.ssg.wms.outbound.domain.dto.OutboundDTO">
        <id property="outboundRequestId" column="outboundRequest_ID"/>
        <result property="outboundDate" column="outboundDate"/>
        <result property="approvedStatus" column="approvedStatus"/>
        <result property="memberId" column="member_id"/>
        <result property="warehouseId" column="warehouse_id"/>
        <result property="staffId" column="staff_id"/>
        <result property="outboundAddress" column="outboundAddress"/>
        <result property="requestedDeliveryDate" column="requestedDeliveryDate"/>
    </resultMap>



    <!-- ✅ 출고요청 등록 -->
    <insert id="insertOutboundRequest" useGeneratedKeys="true" keyProperty="outboundRequestId">
        INSERT INTO outboundRequest (
        outboundDate,
        approvedStatus,
        outboundAddress,
        member_id,
        warehouse_id,
        staff_id,
        requestedDeliveryDate
        ) VALUES (
        NOW(),
        '승인대기',
        #{outboundAddress},
        #{memberId},
        #{warehouseId},
        #{staffId},
        #{requestedDeliveryDate}
        )
    </insert>






    <!-- ✅ 전체 출고요청 조회 -->
    <select id="selectAllShipment" resultMap="OutboundRequestListMap">
        SELECT
        sr.outboundRequest_ID,
        p.product_name,
        m.member_name,
        sr.outboundDate,
        sr.approvedStatus
        FROM outboundRequest sr
        INNER JOIN outboundItem si ON sr.outboundRequest_ID = si.outboundRequest_ID
        INNER JOIN Member m ON sr.member_id = m.member_id
        INNER JOIN Product p ON si.Product_ID = p.product_id
        WHERE sr.member_id = #{userId}
        <if test="status != null">
            AND sr.approvedStatus = #{status}
        </if>
        ORDER BY sr.outboundDate DESC
    </select>



    <!-- ✅ 특정 사용자 출고요청 목록 조회 -->
    <select id="selectOutboundRequestByUserId" resultMap="OutboundRequestListMap">
        SELECT
        sr.outboundRequest_ID,
        p.partner_name,
        m.member_name,
        sr.outboundDate,
        sr.approvedStatus
        FROM outboundRequest sr
        INNER JOIN Member m ON sr.member_id = m.member_id
        INNER JOIN Partner p ON p.partner_id = m.partner_id
        WHERE m.member_id = #{userId}
        <if test="status != null and status != ''">
            AND sr.approvedStatus = #{status}
        </if>
    </select>



    <!-- ✅ 출고요청 상세 조회 -->
    <resultMap id="OutboundRequestDetailMap" type="com.ssg.wms.outbound.domain.dto.OutboundDTO">
        <id property="outboundRequestId" column="outboundRequest_ID"/>
        <result property="outboundDate" column="outboundDate"/>
        <result property="approvedStatus" column="approvedStatus"/>
        <result property="outboundAddress" column="outboundAddress"/>
        <result property="requestedDeliveryDate" column="requestedDeliveryDate"/>
        <collection property="shipmentItems" ofType="com.ssg.wms.outbound.domain.dto.OutboundItemDTO">
            <id property="outboundItemId" column="outbound_item_id"/>
            <result property="outboundQuantity" column="outboundQuantity"/>
            <result property="productName" column="product_name"/>
            <result property="categoryName" column="category_name"/>
        </collection>
    </resultMap>

    <select id="getRequestDetailByUser" resultMap="OutboundRequestDetailMap">
        SELECT
        sr.outboundRequest_ID, sr.outboundDate, sr.approvedStatus,
        sr.outboundAddress, sr.requestedDeliveryDate,
        si.outbound_item_id, si.outboundQuantity,
        p.product_name, c.category_name, m.member_name, st.staff_name
        FROM outboundRequest sr
        INNER JOIN outboundItem si ON sr.outboundRequest_ID = si.outboundRequest_ID
        INNER JOIN Product p ON si.Product_ID = p.product_id
        INNER JOIN Category c ON p.category_cd = c.category_cd
        INNER JOIN Member m ON sr.member_id = m.member_id
        INNER JOIN Staff st ON sr.staff_Id = st.staff_id
        WHERE sr.outboundRequest_ID = #{outboundRequestId}
        AND sr.member_Id = #{userId}
    </select>

    <!-- ✅ 출고요청 수정 -->
    <update id="updateOutboundRequestMain">
        UPDATE outboundRequest
        SET
        outboundAddress = #{dto.outboundAddress},
        requestedDeliveryDate = #{dto.requestedDeliveryDate}
        WHERE outboundRequest_ID = #{outboundRequestId}
        AND member_id = #{userId}
    </update>

    <!-- ✅ 출고 품목 수정 -->
    <update id="updateOutboundItem">
        UPDATE outboundItem
        SET
        Product_ID = #{item.productId},
        outboundQuantity = #{item.outboundQuantity}
        WHERE outbound_item_id = #{item.outboundItemId}
        AND outboundRequest_ID = #{outboundRequestId}
    </update>

    <!-- ✅ 출고 품목 삭제 -->
    <delete id="deleteOutboundItemsByRequestId">
        DELETE FROM outboundItem
        WHERE outboundRequest_ID = #{outboundRequestId}
    </delete>

    <!-- ✅ 출고 지시서 삭제 -->
    <delete id="deleteShipmentOrder">
        DELETE FROM shipmentOrder
        WHERE outboundRequest_ID = #{outboundRequestId}
    </delete>

    <!-- ✅ 출고요청 본문 삭제 -->
    <delete id="deleteRequest">
        DELETE FROM outboundRequest
        WHERE outboundRequest_ID = #{outboundRequestId}
        AND member_id = #{userId}
    </delete>

    <!-- ✅ 출고 승인 상태 조회 -->
    <select id="getOutboundOrderStatusByRequestId" resultType="java.lang.String">
        SELECT approvedStatus
        FROM outboundRequest
        WHERE outboundRequest_ID = #{outboundRequestId}
    </select>

</mapper>
